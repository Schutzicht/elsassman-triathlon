---
import { Menu, X } from 'lucide-astro';

const { lang = Astro.currentLocale || 'en' } = Astro.props;

const currentPath = Astro.url.pathname;
const pathWithoutLang = currentPath.replace(/^\/(en|fr)/, '');
const enHref = `/en${pathWithoutLang}`;
const frHref = `/fr${pathWithoutLang}`;

const translations = {
    en: {
        home: "Home",
        races: "Races",
        info: "Info",
        contact: "Contact",
        register: "Register",
        registerNow: "REGISTER NOW"
    },
    fr: {
        home: "Accueil",
        races: "Courses",
        info: "Informations",
        contact: "Contact",
        register: "S'inscrire",
        registerNow: "S'INSCRIRE MAINTENANT"
    }
};

const t = translations[lang] || translations.en;

const links = [
    { name: t.home, href: `/${lang}` },
    { 
        name: t.races, 
        href: "#", 
        dropdown: [
            { name: "Distance L", href: `/${lang}/races/distance-l` },
            { name: "Distance M", href: `/${lang}/races/distance-m` },
            { name: "Distance S", href: `/${lang}/races/distance-s` },
            { name: "Avenir 1 (6-9yo)", href: `/${lang}/races/avenir-1` },
            { name: "Avenir 2 (10-13yo)", href: `/${lang}/races/avenir-2` }
        ]
    },
    { 
        name: t.info, 
        href: "#", 
        dropdown: [
            { name: lang === 'fr' ? "Programme" : "Program", href: `/${lang}/info/schedule` },
            { name: lang === 'fr' ? "Guide de l'Athlète" : "Athlete Guide", href: `/${lang}/info/athlete-guide` },
            { name: lang === 'fr' ? "Règlement" : "Rules", href: `/${lang}/info/rules` },
            { name: lang === 'fr' ? "Bénévoles" : "Volunteers", href: `/${lang}/benevoles` },
            { name: lang === 'fr' ? "Résultats" : "Results", href: `/${lang}/info/results` }
        ]
    },
    { name: t.contact, href: `/${lang}/contact` },
];
---

<div class="fixed top-0 md:top-6 left-0 w-full z-50 flex justify-center transition-all duration-500" id="navbar-container">
    <header 
        id="main-header" 
        class="w-full max-w-7xl bg-brand-dark/20 backdrop-blur-3xl border border-white/5 px-6 lg:px-12 py-3 transition-all duration-500 relative"
    >
        <div class="flex items-center justify-between">
            <a href="/" class="flex items-center space-x-3 z-50 group">
                <img 
                    src="https://static.wixstatic.com/media/92dadc_7f1facba800c400bbf54d63deb452842~mv2.png/v1/crop/x_221,y_893,w_4560,h_1320/fill/w_176,h_53,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/elsassman%20V3_Plan%20de%20travail%2010.png" 
                    alt="Logo" 
                    class="h-10 w-auto transition-all duration-500 group-hover:scale-110"
                    id="header-logo"
                />
            </a>
            
            <div class="flex md:order-2 items-center">
                <!-- Desktop Language Selector -->
                <div class="hidden md:flex items-center space-x-3 mr-8 border-r border-white/10 pr-8">
                    <a href={enHref} class={`text-[10px] font-black tracking-widest transition-colors ${lang === 'en' ? 'text-brand-primary' : 'text-white/40 hover:text-white'}`}>EN</a>
                    <span class="text-white/10">|</span>
                    <a href={frHref} class={`text-[10px] font-black tracking-widest transition-colors ${lang === 'fr' ? 'text-brand-primary' : 'text-white/40 hover:text-white'}`}>FR</a>
                </div>

                <button 
                    id="menu-toggle"
                    type="button" 
                    class="inline-flex items-center p-2 text-white md:hidden hover:text-brand-primary" 
                >
                    <Menu class="w-6 h-6 transition-all" id="menu-icon-open" />
                    <X class="w-6 h-6 hidden transition-all" id="menu-icon-close" />
                </button>
                <div class="hidden md:block">
                    <a href={`/${lang}/inscriptions`} class="btn-primary py-2 px-6 text-xs transition-all">
                        {t.register}
                    </a>
                </div>
            </div>

            <nav class="hidden md:flex w-full md:w-auto md:order-1" id="navbar-sticky">
                <ul class="flex flex-col p-4 md:p-0 font-tech md:space-x-10 md:flex-row">
                    {links.map((link) => (
                        <li class="relative group">
                            {link.dropdown ? (
                                <>
                                    <button class="flex items-center justify-between w-full py-2 px-3 text-white/60 group-hover:text-brand-primary transition-colors duration-300 uppercase tracking-[0.2em] text-[10px] font-black">
                                        {link.name}
                                        <svg class="w-2 h-2 ms-2 transition-transform group-hover:rotate-180" fill="none" viewBox="0 0 10 6">
                                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                                        </svg>
                                    </button>
                                    <div class="z-50 hidden md:group-hover:block absolute top-full left-1/2 -translate-x-1/2 pt-4 min-w-[200px]">
                                        <div class="bg-brand-dark/95 backdrop-blur-3xl border border-white/5 py-4 px-2">
                                            <ul class="space-y-1">
                                                {link.dropdown.map((subLink) => (
                                                    <li>
                                                        <a href={subLink.href} class="block px-4 py-2 hover:bg-brand-primary hover:text-black transition-all text-[10px] font-bold uppercase tracking-widest text-center">
                                                            {subLink.name}
                                                        </a>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    </div>
                                </>
                            ) : (
                                <a 
                                    href={link.href} 
                                    class="block py-2 px-3 text-white/60 hover:text-brand-primary transition-colors duration-300 uppercase tracking-[0.2em] text-[10px] font-black"
                                >
                                    {link.name}
                                </a>
                            )}
                        </li>
                    ))}
                </ul>
            </nav>
        </div>
    </header>
</div>

<!-- Mobile Menu Overlay -->
<div 
    id="mobile-menu-overlay"
    class="fixed inset-0 bg-brand-dark/98 backdrop-blur-2xl z-[100] transform translate-x-full transition-transform duration-500 ease-in-out md:hidden flex flex-col pt-32 px-10"
>
    <div class="absolute top-6 right-6">
         <button 
          id="close-menu"
          type="button" 
          class="text-white hover:text-brand-primary p-4 focus:outline-none cursor-pointer scale-125"
        >
          <X class="w-8 h-8" />
        </button>
    </div>

    <!-- Mobile Nav Links -->
    <nav class="flex flex-col space-y-8">
        {links.map((link) => (
            <div class="space-y-4">
                {link.dropdown ? (
                    <>
                        <span class="text-brand-primary font-tech text-[10px] font-black uppercase tracking-[0.4em] block mb-2 opacity-50">
                            {link.name}
                        </span>
                        <div class="flex flex-col space-y-4 pl-4 border-l border-brand-primary/20">
                            {link.dropdown.map((subLink) => (
                                <a
                                    href={subLink.href}
                                    class="text-3xl font-display font-black text-white italic hover:text-brand-primary transition-all duration-300"
                                >
                                    {subLink.name}
                                </a>
                            ))}
                        </div>
                    </>
                ) : (
                    <a
                        href={link.href}
                        class="text-5xl font-display font-black text-white italic hover:text-brand-primary transition-all duration-300"
                    >
                        {link.name}
                    </a>
                )}
            </div>
        ))}
        
        <div class="pt-12">
            <a href={`/${lang}/inscriptions`} class="btn-primary w-full py-4 text-center text-sm">
                {t.registerNow}
            </a>
        </div>

        <!-- Mobile Language Selector -->
        <div class="pt-8 mt-8 border-t border-white/10 flex items-center space-x-8">
            <a href={enHref} class={`text-xl font-tech font-black tracking-widest transition-colors ${lang === 'en' ? 'text-brand-primary' : 'text-white/40'}`}>EN</a>
            <a href={frHref} class={`text-xl font-tech font-black tracking-widest transition-colors ${lang === 'fr' ? 'text-brand-primary' : 'text-white/40'}`}>FR</a>
        </div>
    </nav>
</div>

<script>
    const setupNavbar = () => {
        const header = document.getElementById('main-header');
        const container = document.getElementById('navbar-container');
        const menuBtn = document.getElementById('menu-toggle');
        const closeBtn = document.getElementById('close-menu');
        const mobileMenu = document.getElementById('mobile-menu-overlay');
        const menuLinks = mobileMenu?.querySelectorAll('a');

        // Scroll Logic
        const updateNavbar = () => {
            if (window.scrollY > 50) {
                header?.classList.add('bg-brand-dark/80');
                header?.classList.remove('bg-brand-dark/20');
                container?.classList.remove('md:top-6');
                container?.classList.add('top-0');
            } else {
                header?.classList.remove('bg-brand-dark/80');
                header?.classList.add('bg-brand-dark/20');
                if (window.innerWidth >= 768) {
                    container?.classList.add('md:top-6');
                }
                container?.classList.remove('top-0');
            }
        };

        window.addEventListener('scroll', updateNavbar);
        window.addEventListener('resize', updateNavbar);
        updateNavbar();

        // Mobile Menu Logic
        function toggleMenu() {
            mobileMenu?.classList.toggle('translate-x-full');
            document.body.classList.toggle('overflow-hidden');
        }

        menuBtn?.addEventListener('click', toggleMenu);
        closeBtn?.addEventListener('click', toggleMenu);

        menuLinks?.forEach(link => {
            link.addEventListener('click', () => {
                if (!mobileMenu?.classList.contains('translate-x-full')) {
                    toggleMenu();
                }
            });
        });
    };

    // Run on initial load and after view transitions
    setupNavbar();
    document.addEventListener('astro:page-load', setupNavbar);
</script>
